---
title: "milestone4_groupZ"
output: pdf_document
date: '2022-11-19'
author:   'Aubrey Robinson, Elizabeth Guzman, Tin Ho (Group Z)'
---

# Project and Milestone overview

[Pasted to group's gdoc:](https://docs.google.com/document/d/1u4-f0KCUB0QGxWI1VVgfEgEaTmQbt-Jk1uIgWP-0VYk/edit#)


# R setup and load libraries

(this code block omitted for brevity)

```{r load-lib, include=FALSE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)
library(lubridate)

# omit warning messages from library load
# https://stackoverflow.com/questions/45399587/how-to-remove-warning-messages-in-r-markdown-document
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

```

## Loading & Cleaning data from Milestone 4

**Suggestions from Lauren: 
  -confirm we're not double counting deaths in mortality data 
  -summarize mortality rates by county and use rates instead of counts before joining 


```{r massage mortality data, echo=FALSE, include=FALSE}

# Loading Mortality Data 

mortality_path <- 'data/ca_county_mortality.csv'
mortality_data_raw <- read_csv(mortality_path, 
                           na= c("", "NA", "-"),
                           show_col_types=F)

mortality_data <- mortality_data_raw %>% mutate_all(~replace( ., is.na(.), 0))

# View(mortality_data)
# There are NA values in mortality_data, so we need to replace NA w/ 0

mortality_data %>% select( Year ) %>% unique()
# Mortality data is from 2014 - 2020.

# subset mortality data for chronic conditions only

chronic_desc = c( 
  "Chronic lower respiratory diseases",
  "Diabetes mellitus",
  "Diseases of heart",
  "Essential hypertension and hypertensive renal disease",
  "Chronic liver disease and cirrhosis",
  "Alzheimer's disease",
  "Malignant neoplasms",
  "Nephritis, nephrotic syndrome and nephrosis",
  "Cerebrovascular diseases",
  "Parkinson's disease"
  )

chronic_mortality_data = mortality_data %>% 
  filter( Cause_Desc %in% chronic_desc )

num_rows_befor_filter = mortality_data %>% tally
num_rows_after_filter = chronic_mortality_data %>% tally
#num_rows_after_filter

num_rows_filtered = num_rows_befor_filter - num_rows_after_filter
num_rows_filtered


#View(chronic_mortality_data)

# chronic case count by county in the last 5 years
# Question prompt:
## Second, OHEâ€™s director would also like to include a total count of mortality 
## from chronic health conditions 
## over the past few years into the county level analysis. 


chronic_by_county = chronic_mortality_data %>%
  filter(  Strata == "Total Population") %>%
  filter(  Geography_Type == "Occurrence" ) %>%
  select( -Geography_Type ) %>% # Geo type restricted to "Occurrence"
  filter( Year > 2016 )     %>%   # 2016-2020 = 5 years
  group_by( County ) %>%
  summarize( sum_count = sum(Count) )

```

```{r massage funding data, echo=FALSE, include=FALSE}



# Loading HCAI funding Data 

funding_path = 'data/hcai_healthcare_construction.csv'
funding_data <- read_csv(  funding_path, 
                           na= c("", "NA", "-"),
                           show_col_types=F       )

CtyColl = select(funding_data, c("Collection of Counties")) %>%
  unique()

CtyColl 
## there are 4 collection of counties, 
## there aren't likely needed for data eval,
## but add lots of NA, so dropping them
#1 Bay Area Counties           
#2 NA                          
#3 Greater Sacramento Counties 
#4 Greater Los Angeles Counties

# finding where in the data frame there is an 'na'
# https://www.geeksforgeeks.org/find-columns-and-rows-with-na-in-r-dataframe/
## funding_data_no_CtyColl = select(funding_data, -c("Collection of Counties"))
funding_data = select(funding_data, -c("Collection of Counties"))

## which(is.na(funding_data_no_CtyColl), arr.ind=T)
# above returns 0 rows, ie
# we find that only the column "Collection of Counties" has 'na'
# we will leave this for now since it may just be a colloquial reference
# unimportant for our data analysis.
# no replacement for na with 0 will be done on this data frame.



# the Costs column has human data, eg $50,890,315.00
# and we need to strip the dollar sign, the commas, 
# and convert them to numbers.  
# ref: https://stackoverflow.com/questions/31944103/convert-currency-with-commas-into-numeric
# we create a new column for this called "Numeric_Cost", 
# but could have potentially done an in-place replacement
funding_data = funding_data %>% 
  mutate(Numeric_Cost = as.numeric(
    gsub( '[$,]', '', funding_data[["Total Costs of OSHPD Projects"]] ) 
  ))

funding_data = funding_data %>%
  mutate( county_name = str_sub( County, 6 )) %>%
  subset(select = -c(County)) %>%
  rename(County = county_name)


# subset HCAI funding data for those "In Closure" state

funding_data <- funding_data %>%
  filter(`OSHPD Project Status` == "In Closure") %>%
  filter(`Data Generation Date` == as_date("2022-08-11")  )


  ## is 2022-08-11 the latest avail data? ++CHECK++

    #group_by(County, Numeric_Cost, `OSHPD Project Status`) %>%  
  ## I (Tin) can no longer get the the gruop_by  to work... 

funding_data %>% arrange( Numeric_Cost ) %>% head( 10 )


#### Not sure why instruction team want us to focus on "In Closure"
#### maybe stop the project from closing and fund it further?
#### but if cost is 0 means there isn't actually any project?

```


```{r massage demographics data, echo=FALSE, include=FALSE}


# Load demographics data

demographics_path = 'data/ca_county_demographics.csv'
demographics_data = read_csv( demographics_path, 
                              na = c("", "NA", "-"), 
                              show_col_types=F )

# the first column contains id number, but it is unamed, so renaming it
# rest of the columns have reasonable names, so left them as is.
demographics_data = rename( demographics_data, id="...1")

# View(demographics_data)


# massaging demographics data

demographics_data <- demographics_data %>%
  select(id, name, pop2012, pop12_sqmi, med_age, owner_occ, renter_occ) %>%
  rename( `County` = name )


## Determining Renters vs Homeowners Ratio
demographics_data = demographics_data %>%
  mutate( rent_own_ratio = renter_occ / owner_occ )


demographics_data <- 
  mutate(demographics_data, 
         rural_class=if_else( pop12_sqmi < 20, "rural", "not rural", missing=NULL))

# column to show whether county was rural or not
rural_not_rural <- demographics_data %>% 
  select( County, rural_class, pop12_sqmi, rent_own_ratio, med_age )  

rural_counties = rural_not_rural   %>%
  filter( rural_class == "rural" ) 
  #rename( `Class`  = rural_class )


#### consider a "low pop density" rather than a strict "rural"
#### --> not really good, 49 counties in this grouping

avg_pop_density = mean( demographics_data$pop12_sqmi )
demographics_data = demographics_data %>% 
  mutate( low_pop = if_else( pop12_sqmi < avg_pop_density , 
                                    TRUE,
                                    FALSE,
                                    NULL   ))


```


```{r demographics data complete set high rental, old age, echo=FALSE, include=FALSE}

high_rental_ratio = 
  rural_counties %>% arrange( desc( rent_own_ratio  ) ) 

high_med_age = 
  rural_counties %>% arrange( desc( med_age  ) ) 

## Determine any counties satisfy triple whammy rule

avg_rent_ratio = mean( demographics_data$rent_own_ratio )
avg_age        = mean( demographics_data$med_age  )

demographics_data = demographics_data %>% 
  mutate( high_med_age = if_else( med_age > avg_age , 
                                    TRUE,
                                    FALSE,
                                    NULL   )) %>%
  mutate( high_rental = if_else( rent_own_ratio > avg_rent_ratio , 
                                    TRUE,
                                    FALSE,
                                    NULL   )) 
  
triple_whammy = demographics_data %>%
  filter( rural_class  == "rural" &
          high_rental  == TRUE    &  
          high_med_age == TRUE       )

### so 0 county satisfy the triple whammy rule
### need to modify  selection criteria
```


```{r demographics data RURAL set only, high rental, old age, echo=FALSE, include=FALSE}

## Use only RURAL counties to calculate their averages, and what's above average

## Determine any RURAL counties satisfy double whammy rule
#View(rural_counties)

avg_rent_ratio_rural = mean( rural_counties$rent_own_ratio )
avg_age_rural        = mean( rural_counties$med_age  )



rural_demographics_data = demographics_data %>% 
  mutate( high_med_age_rural = if_else( med_age > avg_age_rural , 
                                    TRUE,
                                    FALSE,
                                    NULL   )) %>%
  mutate( high_rental_rural = if_else( rent_own_ratio > avg_rent_ratio_rural , 
                                    TRUE,
                                    FALSE,
                                    NULL   )) 

#-- c( avg_rent_ratio, avg_rent_ratio_rural, avg_age, avg_age_rural )
#-- sn50 =  rural_demographics_data %>% filter( rural_class == "rural" ) 
```

```{r tmp-double-whammy}

rural_double_whammy = rural_demographics_data %>%
  filter( 
          high_rental_rural  == TRUE    &  
          high_med_age_rural == TRUE       )



rural_double_whammy  # only 3 counties in this list: Lake, Siskiyou, Inyo

rural_demographics_data %>% arrange( rent_own_ratio, med_age ) %>% head( 6 )

```


```{r dem relaxed criteria: old age, high rental in rural standard, echo=FALSE, include=FALSE}

## determine old age as > avg age for full data set
## then pick rural countries, 
## high rental in such rural counties.


#View(rural_counties)


focus_demographics_data = demographics_data %>% 
  mutate( high_rental_rural = if_else( rent_own_ratio > avg_rent_ratio_rural , 
                                    TRUE,
                                    FALSE,
                                    NULL   )) %>%
  mutate( high_med_age = if_else( med_age > avg_age , 
                                    TRUE,
                                    FALSE,
                                    NULL   ))

#-- c( avg_rent_ratio, avg_rent_ratio_rural, avg_age, avg_age_rural )
#-- sn50 =  focus_demographics_data %>% filter( rural_class == "rural" ) 

```

```{r tmp-focus}

focus_dem = rural_demographics_data %>%
  filter( 
          high_rental_rural  == TRUE    &  
          high_med_age == TRUE       )    %>%
  select( County, rural_class, high_med_age, high_rental_rural )


rural_demographics_data %>%
  select( County, rural_class, med_age, high_med_age, high_rental_rural ) %>%
  arrange( high_rental_rural, desc(med_age) )



#View(focus_dem)  # now have 13 counties to choose from

```



```{r tmp}

## decide if need to output any of these tables
## likely need to refine further 

high_rental_ratio %>% head( 6 )

high_med_age %>% head( 6 )

rural_double_whammy %>% head( 6 )

focus_dem %>% head( 13 )

```


It doesn't seems like we have high rental (ie > avg_rent) and old age (>avg_age)
so we will have to judge subjectively
-Tin


```{r join tables, echo=FALSE, include=FALSE}


# Join Chronics mortality data (by county, last 5 years)
# and demographics data

demographics_chronic = left_join( demographics_data, 
                                  chronic_by_county, 
                                  by = "County"      ) %>% 
  mutate( prevalence = ( sum_count / pop2012) * 1000 )
  

fund_dem_chron = inner_join( demographics_chronic,
                             funding_data, 
                             by = "County" ) %>%
  mutate( fund_per_cap = Numeric_Cost / pop2012 )

viz_fund_dem_chron = fund_dem_chron %>%
  select( County, 
          #pop12_sqmi,
          rural_class,  
          low_pop,
          med_age,
          high_med_age,
          rent_own_ratio,
          high_rental,
          prevalence,
          Numeric_Cost, 
          fund_per_cap,
          `Number of OSHPD Projects`,
          )

```


```{r DRAFT tables for viz }

#### for viz, ponder about using these, or derivative thereof 

feel_for_data = viz_fund_dem_chron %>% 
  filter( rural_class == "rural" ) 
  #filter( low_pop == TRUE )         # no good, 49 counties in this grouping

feel_for_data %>% 
  arrange( desc( fund_per_cap ) ) 
### above are all 0... why "In Closure"... need to poke more...


viz_focus = viz_fund_dem_chron %>%
  filter( low_pop      == TRUE,
          high_med_age == TRUE 
          ##high_rental  == TRUE  
          )


viz_focus %>% head( 10 )


```

\newpage 

#Visualizations

Data needed to make decision:
-which counties share all 3 attributes: low pop(rural), high median age, 
& high proportion of renters vs homeowners
-which 5 counties have highest mortality rates due to chronic illness
-what counties have received little to no funding recently? ---not quite sure 
about this one

#Print Quality Table

```{r}

```

#Print Quality Plot or Chart

```{r}

```

#Print Quality Table, Plot or Chart

```{r}

```


### PS

Mortality data is from 2014 - 2020, and want "last few years"

Demographics data has pop2012

Funding we are using latest, 2022-08-11, earliest is 2013.

In real world we should use the latest data that is on a consistent state, for this exercise, we picked a date from each data set and then just pretend they can be joined.
