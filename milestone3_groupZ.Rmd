---
title:    'PHW251 Fall 2022 Project Milestone ยง 3'
author:   'Aubrey Robinson, Elizabeth Guzman, Tin Ho (Group Z)'
date:     'Due: 2022-11-07'
output:   pdf_document
---

# Project and Milestone overview

[Pasted to group's gdoc:](https://docs.google.com/document/d/1u4-f0KCUB0QGxWI1VVgfEgEaTmQbt-Jk1uIgWP-0VYk/edit#)


# R setup and load libraries

(this code block omitted for brevity)

```{r load-lib, include=FALSE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)

# omit warning messages from library load
# https://stackoverflow.com/questions/45399587/how-to-remove-warning-messages-in-r-markdown-document
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


```

## Loading data

(this code block currently is all from Milestone 2)

```{r load-data, echo=FALSE, include=FALSE}

#   - Utilize function arguments to control relevant components 
#     (i.e. change column types, column names, missing values, etc.)

demographics_path = 'data/ca_county_demographics.csv'
demographics_data = read_csv( demographics_path, 
                              na = c("", "NA", "-"), 
                              show_col_types=F )
# the first column contains id number, but it is unamed, so renaming it
# rest of the columns have reasonable names, so left them as is.
demographics_data = rename( demographics_data, id="...1")

# View(demographics_data)

# Loading Mortality Data 

mortality_path <- 'data/ca_county_mortality.csv'
mortality_data_raw <- read_csv(mortality_path, 
                           na= c("", "NA", "-"),
                           show_col_types=F)


mortality_data <- mortality_data_raw %>% mutate_all(~replace( ., is.na(.), 0))

# View(mortality_data)
# There are NA values in mortality_data, so we need to replace NA w/ 0
 

# Loading HCAI funding Data 

funding_path = 'data/hcai_healthcare_construction.csv'
funding_data <- read_csv(  funding_path, 
                           na= c("", "NA", "-"),
                           show_col_types=F       )

# finding where in the data frame there is an 'na'
# https://www.geeksforgeeks.org/find-columns-and-rows-with-na-in-r-dataframe/
funding_data_no_CtyColl = select(funding_data, -c("Collection of Counties"))
which(is.na(funding_data_no_CtyColl), arr.ind=T)
# and we find that only the column "Collection of Counties" has 'na'
# we will leave this for now since it may just be a colloquial reference
# unimportant for our data analysis.
# no replacement for na with 0 will be done on this data frame.


# the Costs column has human data, eg $50,890,315.00
# and we need to strip the dollar sign, the commas, 
# and convert them to numbers.  
# ref: https://stackoverflow.com/questions/31944103/convert-currency-with-commas-into-numeric
# we create a new column for this called "Numeric_Cost", 
# but could have potentially done an in-place replacement
funding_data = funding_data %>% 
  mutate(Numeric_Cost = as.numeric(
    gsub( '[$,]', '', funding_data[["Total Costs of OSHPD Projects"]] ) 
  ))


```

\newpage


# Subset rows or columns, as needed

## Subset mortality data by Chronic diseases

For this project, we are asked to focus on the chronic diseases.
The mortality data set include non chronic diseases.

After discussion in ed.com, 
https://edstem.org/us/courses/25507/discussion/2060979 ,
the chronic disease list is defined as below, 
which seems to agree with CDC definition as well

  "Chronic lower respiratory diseases",
  "Diabetes mellitus",
  "Diseases of heart",
  "Essential hypertension and hypertensive renal disease",
  "Chronic liver disease and cirrhosis",
  "Alzheimer's disease",
  "Malignant neoplasms",
  "Nephritis, nephrotic syndrome and nephrosis",
  "Cerebrovascular diseases",
  "Parkinson's disease"
  
We also need to review the most recent HCAI funding for projects in closure in 
each county. Below, is the funding_data subsetted for projects closed in August 2022


```{r subset_data}

chronic_desc = c( 
  "Chronic lower respiratory diseases",
  "Diabetes mellitus",
  "Diseases of heart",
  "Essential hypertension and hypertensive renal disease",
  "Chronic liver disease and cirrhosis",
  "Alzheimer's disease",
  "Malignant neoplasms",
  "Nephritis, nephrotic syndrome and nephrosis",
  "Cerebrovascular diseases",
  "Parkinson's disease"
  )


chronic_mortality_data = mortality_data %>% 
  filter( Cause_Desc %in% chronic_desc )

num_rows_befor_filter = mortality_data %>% tally
num_rows_after_filter = chronic_mortality_data %>% tally

num_rows_filtered = num_rows_befor_filter - num_rows_after_filter
num_rows_filtered

funding_data <- funding_data %>%
  group_by(County, Numeric_Cost, `OSHPD Project Status`) %>%
  filter(`OSHPD Project Status` == "In Closure") %>%
  filter(`Data Generation Date` == "2022-08-11")
  


demographics_data <- demographics_data %>%
  select(id, name, pop2012, pop12_sqmi, med_age, owner_occ, renter_occ)

```
And we find that we remove 58,000+ rows of data that we don't need.

Other subsetting maybe needed, and we will develop them as we make progress on this project.


  
\newpage 

# Create New Variables

- Create new variables needed for analysis (minimum 2)
  - New variables should be created based on existing columns; for example
    - Calculating a rate
    - Combining character strings
    
## Renters vs Homeowners

The following code block creates a new variable rent_own_ratio

```{r create_new_vars}

## Renters vs Homeowners Ratio
demographics_data = demographics_data %>%
  mutate( rent_own_ratio = renter_occ / owner_occ )


```

## Rural Areas

For the second new variable, we are categorizing one of our existing variables as either "rural" or "not rural". We are using the National Rural Development Partnership's definition which counts an area with less than 20 people per square mile rural. 
```{r}
demographics_data<- mutate(demographics_data, rural_class=if_else(pop12_sqmi < 20, 
                                                                  "rural", "not rural", missing=NULL))
```


\newpage 



# Clean variables needed for analysis (minimum 2)


In the funding_data table, County is coded like "19 - Los Angeles", "01 - Alameda".
We need county name by itself for later table join process, 
thus we need to "clean out" the id portion in this data field.
We store this cleaned data in a new column called County.

We note that the county code is prefixed with 0 when they are single digits,
thus it is always the first 5 chars that need to be stripped out.

```{r clean_vars}

funding_data = funding_data %>%
  mutate( county_name = str_sub( County, 6 )) %>%
  subset(select = -c(County)) %>%
  rename(County = county_name)


#  ++ Is the data field coded as R's date data structure?
# typeof( funding_data$`Data Generation Date` )
# typeof( as_date("2022-11-01"))

```


\newpage 

# Data dictionary based on clean dataset (minimum 4 data elements)


- We find all 3 tables have county names in it, which can be used as key for joining these tables.
However, in 1 case we need to use a cleaned version of this column.  Overall, 
county name is a character data field contained in :
  - demographics_data  Name
  - funding_data       County
  - mortality_data     County
  
  
# Joining Table 

```{r}
demographics_chronic <- left_join(demographics_data, chronic_mortality_data, 
                                  by = c("name" = "County"))


```



\newpage 

# One or more tables with descriptive statistics for 4 data element

++ write up tbd
++ kable table still not formatted great, feel free to fiddle and improve on!


```{r desc_stat, echo=FALSE}

# development aid only, not needed in final presentation
#--uniq_cause_desc = mortality_data %>% pull(Cause_Desc) %>% unique()
#--uniq_cause_code = mortality_data %>% pull(Cause)      %>% unique()
#--uniq_cause = chronic_mortality_data %>% pull( Cause, Cause_Desc ) %>% unique()

#--uniq_cause_desc
#--uniq_cause_code
#--uniq_cause # "ALZ" "CAN" "CLD" "DIA" "HTD" "HYP" "LIV" "NEP" "PAR" "STK"


## DRAFT

## below produce a table for the average case count in 2014-2020
## grouped by county
## and sorted in descending order by aggregate cases
## however, more populous county will have more cases
## this may not be good criteria for later steps of the project
## at least not by itself, 
## perhaps if we have way to select by rural county...
## but this table should satisfy the requirement for Milestone 3


## ++ prompt says:
## "plan to summarize a total count of occurrences"
## does this means ignore Geography_Type == "Residence" ?


chronic_table = chronic_mortality_data %>% 
  filter( Geography_Type == "Occurrence" ) %>%
  select( -Geography_Type ) %>% # Geo type restricted to "Occurrence"
  filter( Strata == "Total Population") %>%
  group_by( County, Cause, Year ) %>%
  summarize( avg_count = mean(Count), 
             County, Cause, Cause_Desc ) %>%
  filter(  Year==2014 ) %>% # all year have same data after group_by, just pick 1
  data.frame() %>%                            # "flatten" the group_by hierarchy
  select( County, Cause, avg_count ) %>%
  pivot_wider( names_from="Cause", 
               values_from="avg_count" ) %>%  # avg(case count) 2014-2020
  mutate( `Sum of means chronic cases` = 
            ALZ + CAN + CLD + DIA + HTD + HYP + LIV + NEP + PAR + STK ) %>%
  arrange( desc( `Sum of means chronic cases` ) )



# Need to add caption, 
# ++ is it per 1000 population?

#--chronic_table %>% head(8)

kable( chronic_table,
       booktabs=T,
       digits=c(0,0,0,0,0,0,0,0,0,0,0,2),
       format.args=list(big.mark=',')
       )


```

\newpage 


